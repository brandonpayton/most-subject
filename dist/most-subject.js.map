{"version":3,"file":"most-subject.js","sources":["../src/Subject.js","../src/source/SubjectSource.js","../src/fatalError.js","../src/source/AsyncSubjectSource.js","../src/source/HoldSubjectSource.js","../src/index.js"],"sourcesContent":["/* @flow */\nimport {Stream} from 'most'\n\n/** The base Subject class, which is an extension of Stream\n * @typedef {Object} Subject\n */\nexport class Subject extends Stream {\n  /**\n   * Push a new value to the stream\n   *\n   * @method next\n   *\n   * @param  {any}   value The value you want to push to the stream\n   */\n  next (value: any) {\n    this.source.next(value)\n  }\n\n  /**\n   * Push an error and end the stream\n   *\n   * @method error\n   *\n   * @param  {Error} err The error you would like to push to the stream\n   */\n  error (err: Error) {\n    this.source.error(err)\n  }\n\n  /**\n   * Ends the stream with an optional value\n   *\n   * @method complete\n   *\n   * @param  {any} value The value you would like to end the stream on\n   */\n  complete (value: any) {\n    this.source.complete(value)\n  }\n}\n","/* @flow */\nimport defaultScheduler from 'most/lib/scheduler/defaultScheduler'\nimport {MulticastSource} from '@most/multicast'\n\nexport function SubjectSource () {\n  // TODO: QUESTION: Why is the default schedule used when one is supplied to `run`?\n  this.scheduler = defaultScheduler\n  this.sinks = []\n  this.active = true\n}\n\n// Source methods\nSubjectSource.prototype.run = function (sink: Object, scheduler: Object) {\n  const n = this.add(sink)\n  if (n === 1) { this.scheduler = scheduler }\n  return new SubjectDisposable(this, sink)\n}\n\nSubjectSource.prototype._dispose = function dispose () {\n  this.active = false\n}\n\n// Subject methods\nSubjectSource.prototype.next = function next (value: any) {\n  // TODO: QUESTION: Why not throw here?\n  if (!this.active) { return }\n  this._next(this.scheduler.now(), value)\n}\n\nSubjectSource.prototype.error = function error (err: Error) {\n  if (!this.active) { return }\n\n  this.active = false\n  this._error(this.scheduler.now(), err)\n}\n\nSubjectSource.prototype.complete = function complete (value: any) {\n  if (!this.active) { return }\n\n  this.active = false\n  this._complete(this.scheduler.now(), value, this.sink)\n}\n\n// Multicasting methods\n// TODO: QUESTION: Why not extending MulticastSource?\nSubjectSource.prototype.add = MulticastSource.prototype.add\nSubjectSource.prototype.remove = MulticastSource.prototype.remove\nSubjectSource.prototype._next = MulticastSource.prototype.event\nSubjectSource.prototype._complete = MulticastSource.prototype.end\nSubjectSource.prototype._error = MulticastSource.prototype.error\n\n// SubjectDisposable\nfunction SubjectDisposable (source: Object, sink: Object) {\n  this.source = source\n  this.sink = sink\n  this.disposed = false\n}\n\nSubjectDisposable.prototype.dispose = function () {\n  if (this.disposed) { return }\n  this.disposed = true\n  const remaining = this.source.remove(this.sink)\n  return remaining === 0 && this.source._dispose()\n}\n","/* @flow */\n\nexport function fatalError (err: Error) {\n  setTimeout(() => { throw err }, 0)\n}\n","/* @flow */\n\nimport {SubjectSource} from './SubjectSource'\nimport {fatalError} from '../fatalError'\n\nfunction Task (f: Function, e: Function) {\n  this.f = f\n  this.e = e\n  this.active = true\n}\nTask.prototype = {\n  run () {\n    this.active && this.f()\n  },\n  error (err) {\n    this.e(err)\n  },\n  dispose () {\n    this.active = false\n  }\n}\n\n// flow-ignore-next-line: I want to extend another class\nexport class AsyncSubjectSource extends SubjectSource {\n  next (value: any) {\n    this._asap(() => super.next(value), e => this.error(e))\n  }\n\n  error (err: Error) {\n    this._asap(() => super.error(err), e => this._fatalError(e))\n  }\n\n  complete (value: any) {\n    this._asap(() => super.complete(), e => this.error(e))\n  }\n\n  _asap (f: Function, e: Function) {\n    this.scheduler.asap(new Task(f, e))\n  }\n\n  // Expose this for unit test\n  _fatalError (err: Error) {\n    fatalError(err)\n  }\n}\n","/* @flow */\nimport {SubjectSource} from './SubjectSource'\nimport {drop, append} from '@most/prelude'\n\n// flow-ignore-next-line: I want to extend another class\nexport class HoldSubjectSource extends SubjectSource {\n  constructor (bufferSize: number) {\n    super()\n    this.bufferSize = bufferSize\n    this.buffer = []\n  }\n\n  add (sink: Object) {\n    const buffer = this.buffer\n    if (buffer.length > 0) {\n      pushEvents(buffer, sink)\n    }\n    super.add(sink)\n  }\n\n  next (value: any) {\n    if (!this.active) { return }\n    const time = this.scheduler.now()\n    this.buffer = dropAndAppend({time, value}, this.buffer, this.bufferSize)\n    this._next(time, value)\n  }\n}\n\nfunction pushEvents (buffer: any[], sink: Object) {\n  for (let i = 0; i < buffer.length; ++i) {\n    const {time, value} = buffer[i]\n    sink.event(time, value)\n  }\n}\n\nfunction dropAndAppend (event: Object, buffer: any[], bufferSize: number) {\n  if (buffer.length >= bufferSize) {\n    return append(event, drop(1, buffer))\n  }\n  return append(event, buffer)\n}\n","/* @flow */\nimport {Subject} from './Subject'\nimport {SubjectSource} from './source/SubjectSource'\nimport {AsyncSubjectSource} from './source/AsyncSubjectSource'\nimport {HoldSubjectSource} from './source/HoldSubjectSource'\n\n/**\n * Creates a new Subject\n *\n * @return {Subject} {@link Subject}\n *\n * @example\n * import {subject} from 'most-subject'\n *\n * const stream = subject()\n *\n * stream.map(fn).observe(x => console.log(x))\n * // 1\n * // 2\n *\n * stream.next(1)\n * stream.next(2)\n * setTimeout(() => stream.complete(), 10)\n */\nexport function subject (): Subject {\n  return new Subject(new SubjectSource())\n}\n\n/**\n * Create a subject that emits events, errors, and completion on the next turn.\n *\n * @return {Subject} {@link Subject}\n *\n * @example\n * import {asyncSubject} from 'most-subject'\n *\n * const stream = asyncSubject()\n *\n * let mostRecentValue\n * let subjectCompleted = false\n * stream\n *   .observe(value => mostRecentValue = value)\n *   .then(() => subjectCompleted = true)\n *\n * stream.next(1)\n *\n * // mostRecentValue === undefined\n *\n * Promise.resolve().then(() => {\n *   // mostRecentValue === 1\n * })\n *\n * // subjectCompleted === false\n *\n * stream.complete()\n *\n * Promise.resolve().then(() => {\n *   // subjectCompleted === true\n * })\n */\n// TODO: QUESTION: Should there be an asyncHoldSubject ? -- Is this a question I should ask?\nexport function asyncSubject (): Subject {\n  return new Subject(new AsyncSubjectSource())\n}\n\n/**\n * Create a subject with a buffer to keep from missing events.\n *\n * @param  {number}    bufferSize =             1 The maximum size of the\n * buffer to create.\n *\n * @return {Subject} {@link Subject}\n *\n * @example\n * import {holdSubject} from 'most-subject'\n *\n * const stream = holdSubject(3)\n *\n * stream.next(1)\n * stream.next(2)\n * stream.next(3)\n *\n * stream.map(fn).observe(x => console.log(x))\n * // 1\n * // 2\n * // 3\n *\n * setTimeout(() => stream.complete(), 10)\n */\nexport function holdSubject (bufferSize: number = 1): Subject {\n  if (bufferSize <= 0) {\n    throw new Error('First and only argument to holdSubject `bufferSize` ' +\n      'must be an integer 1 or greater')\n  }\n  return new Subject(new HoldSubjectSource(bufferSize))\n}\n"],"names":["Stream","MulticastSource","append","drop"],"mappings":"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"}