(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?factory(exports,require("most"),require("most/lib/scheduler/defaultScheduler"),require("@most/multicast"),require("@most/prelude")):typeof define==="function"&&define.amd?define(["exports","most","most/lib/scheduler/defaultScheduler","@most/multicast","@most/prelude"],factory):factory(global.mostSubject=global.mostSubject||{},global.most,global.most.defaultScheduler,global.mostMulticast,global.mostPrelude)})(this,function(exports,most,defaultScheduler,_most_multicast,_most_prelude){"use strict";defaultScheduler="default"in defaultScheduler?defaultScheduler["default"]:defaultScheduler;var babelHelpers={};babelHelpers.classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}};babelHelpers.createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();babelHelpers.get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};babelHelpers.inherits=function(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass};babelHelpers.possibleConstructorReturn=function(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self};babelHelpers;var Subject=function(_Stream){babelHelpers.inherits(Subject,_Stream);function Subject(){babelHelpers.classCallCheck(this,Subject);return babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(Subject).apply(this,arguments))}babelHelpers.createClass(Subject,[{key:"next",value:function next(value){this.source.next(value)}},{key:"error",value:function error(err){this.source.error(err)}},{key:"complete",value:function complete(value){this.source.complete(value)}}]);return Subject}(most.Stream);function SubjectSource(){this.scheduler=defaultScheduler;this.sinks=[];this.active=true}SubjectSource.prototype.run=function(sink,scheduler){var n=this.add(sink);if(n===1){this.scheduler=scheduler}return new SubjectDisposable(this,sink)};SubjectSource.prototype._dispose=function dispose(){this.active=false};SubjectSource.prototype.next=function next(value){if(!this.active){return}this._next(this.scheduler.now(),value)};SubjectSource.prototype.error=function error(err){if(!this.active){return}this.active=false;this._error(this.scheduler.now(),err)};SubjectSource.prototype.complete=function complete(value){if(!this.active){return}this.active=false;this._complete(this.scheduler.now(),value,this.sink)};SubjectSource.prototype.add=_most_multicast.MulticastSource.prototype.add;SubjectSource.prototype.remove=_most_multicast.MulticastSource.prototype.remove;SubjectSource.prototype._next=_most_multicast.MulticastSource.prototype.event;SubjectSource.prototype._complete=_most_multicast.MulticastSource.prototype.end;SubjectSource.prototype._error=_most_multicast.MulticastSource.prototype.error;function SubjectDisposable(source,sink){this.source=source;this.sink=sink;this.disposed=false}SubjectDisposable.prototype.dispose=function(){if(this.disposed){return}this.disposed=true;var remaining=this.source.remove(this.sink);return remaining===0&&this.source._dispose()};function fatalError(err){setTimeout(function(){throw err},0)}function Task(f,e){this.f=f;this.e=e;this.active=true}Task.prototype={run:function run(){this.active&&this.f()},error:function error(err){this.e(err)},dispose:function dispose(){this.active=false}};var AsyncSubjectSource=function(_SubjectSource){babelHelpers.inherits(AsyncSubjectSource,_SubjectSource);function AsyncSubjectSource(){babelHelpers.classCallCheck(this,AsyncSubjectSource);return babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(AsyncSubjectSource).apply(this,arguments))}babelHelpers.createClass(AsyncSubjectSource,[{key:"next",value:function next(value){var _this2=this;this._asap(function(){return babelHelpers.get(Object.getPrototypeOf(AsyncSubjectSource.prototype),"next",_this2).call(_this2,value)},function(e){return _this2.error(e)})}},{key:"error",value:function error(err){var _this3=this;this._asap(function(){return babelHelpers.get(Object.getPrototypeOf(AsyncSubjectSource.prototype),"error",_this3).call(_this3,err)},function(e){return _this3._fatalError(e)})}},{key:"complete",value:function complete(value){var _this4=this;this._asap(function(){return babelHelpers.get(Object.getPrototypeOf(AsyncSubjectSource.prototype),"complete",_this4).call(_this4)},function(e){return _this4.error(e)})}},{key:"_asap",value:function _asap(f,e){this.scheduler.asap(new Task(f,e))}},{key:"_fatalError",value:function _fatalError(err){fatalError(err)}}]);return AsyncSubjectSource}(SubjectSource);var HoldSubjectSource=function(_SubjectSource){babelHelpers.inherits(HoldSubjectSource,_SubjectSource);function HoldSubjectSource(bufferSize){babelHelpers.classCallCheck(this,HoldSubjectSource);var _this=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(HoldSubjectSource).call(this));_this.bufferSize=bufferSize;_this.buffer=[];return _this}babelHelpers.createClass(HoldSubjectSource,[{key:"add",value:function add(sink){var buffer=this.buffer;if(buffer.length>0){pushEvents(buffer,sink)}babelHelpers.get(Object.getPrototypeOf(HoldSubjectSource.prototype),"add",this).call(this,sink)}},{key:"next",value:function next(value){if(!this.active){return}var time=this.scheduler.now();this.buffer=dropAndAppend({time:time,value:value},this.buffer,this.bufferSize);this._next(time,value)}}]);return HoldSubjectSource}(SubjectSource);function pushEvents(buffer,sink){for(var i=0;i<buffer.length;++i){var _buffer$i=buffer[i];var time=_buffer$i.time;var value=_buffer$i.value;sink.event(time,value)}}function dropAndAppend(event,buffer,bufferSize){if(buffer.length>=bufferSize){return _most_prelude.append(event,_most_prelude.drop(1,buffer))}return _most_prelude.append(event,buffer)}function subject(){return new Subject(new SubjectSource)}function asyncSubject(){return new Subject(new AsyncSubjectSource)}function holdSubject(){var bufferSize=arguments.length<=0||arguments[0]===undefined?1:arguments[0];if(bufferSize<=0){throw new Error("First and only argument to holdSubject `bufferSize` "+"must be an integer 1 or greater")}return new Subject(new HoldSubjectSource(bufferSize))}exports.subject=subject;exports.asyncSubject=asyncSubject;exports.holdSubject=holdSubject});